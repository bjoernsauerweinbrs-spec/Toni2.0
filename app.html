<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>TONI 2.0 – PRO MATCHDAY</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="pro-layout-container">
        <nav class="sidebar-minimal">
            <div class="control-unit"
                 onclick="window.BriefcaseUI?.toggle('sporttasche')">
                <i class="fas fa-briefcase"></i>
            </div>
            <div class="control-unit"
                 onclick="window.BriefcaseUI?.toggle('analyse')">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="control-unit"
                 onclick="window.BriefcaseUI?.toggle('templates')">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="control-unit"
                 onclick="window.BriefcaseUI?.toggle('system')">
                <i class="fas fa-cog"></i>
            </div>
        </nav>

        <main id="stage-container">
            <canvas id="main-canvas"></canvas>
            <div id="toni-status-bar">
                SYSTEM: <span id="status-text">BOOTING…</span>
            </div>
        </main>

        <aside class="analysis-panel">
            <div id="chat-messages"></div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Befehl…">
                <button id="send-btn">Senden</button>
            </div>
        </aside>
    </div>

    <div id="briefcase-overlay" class="briefcase-overlay" style="display:none;">
        <div class="briefcase-window">
            <div id="active-content"></div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module" src="logic/event-bus.js"></script>
    <script type="module" src="logic/database.js"></script>
    <script type="module" src="logic/llm-gateway.js"></script>
    <script type="module" src="logic/status-manager.js"></script>
    <script type="module" src="logic/toni-core.js"></script>

    <!-- Engine -->
    <script type="module" src="engine/arena.js"></script>

    <!-- UI -->
    <script type="module" src="ui/briefcase-ui.js"></script>
    <script type="module" src="ui/sektoren/sektor-sporttasche.js"></script>
    <script type="module" src="ui/sektoren/sektor-analyse.js"></script>
    <script type="module" src="ui/sektoren/sektor-templates.js"></script>
    <script type="module" src="ui/sektoren/sektor-system.js"></script>

    <script type="module">
    async function waitForGatewayStatus(timeout = 2000) {
        return new Promise((resolve) => {
            let resolved = false;
            const timer = setTimeout(() => {
                if (!resolved) {
                    resolved = true;
                    resolve(null);
                }
            }, timeout);

            try {
                window.ToniEvents?.on('gateway:status', (s) => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(timer);
                        resolve(s);
                    }
                });
            } catch {
                clearTimeout(timer);
                resolve(null);
            }
        });
    }

    async function bootstrap() {
        try {
            if (document.readyState === 'loading') {
                await new Promise(r => window.addEventListener('DOMContentLoaded', r, { once: true }));
            }

            window.ToniDB?.init();
            window.arena?.init('main-canvas');

            window.SektorSporttasche?.init('active-content');
            window.SektorAnalyse?.init('active-content');
            window.SektorTemplates?.init('active-content');
            window.SektorSystem?.init('active-content');

            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');

            function sendMessage() {
                const text = input?.value?.trim();
                if (!text) return;
                window.ToniCore?.processMessage(text);
                input.value = '';
            }

            sendBtn?.addEventListener('click', sendMessage);
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            const gwStatus = await waitForGatewayStatus(2000);
            const statusTextEl = document.getElementById('status-text');

            if (gwStatus) {
                statusTextEl.textContent = 'GATEWAY: ' + String(gwStatus).toUpperCase();
            } else {
                statusTextEl.textContent = 'BEREIT';
            }
        } catch (e) {
            console.error('[BOOT] bootstrap failed', e);
            const statusText = document.getElementById('status-text');
            if (statusText) statusText.textContent = 'BOOT ERROR';
        }
    }

    bootstrap();
    </script>
</body>
</html>
